<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETAKEæµåŠ¨æ€§åˆ†æå™¨ (ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* æ ·å¼ä»£ç ä¿æŒä¸å˜ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #795548, #8d6e63);
            color: white;
            border-radius: 10px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #f44336;
            margin: 20px 0;
        }
        
        .data-comparison {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .input-section, .chart-section, .position-details {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .analyze-btn {
            padding: 12px 30px;
            background: #795548;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .analyze-btn:hover {
            background: #6d4c41;
        }

        .chart-controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-controls button {
            padding: 8px 16px;
            margin: 0 5px;
            border: 2px solid #795548;
            background: white;
            color: #795548;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chart-controls button.active,
        .chart-controls button:hover {
            background: #795548;
            color: white;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #795548;
        }
        
        .summary-card h3 {
            margin: 0 0 15px 0;
            color: #795548;
        }
        
        .summary-card p {
            margin: 8px 0;
            color: #555;
        }

        .position-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #795548;
        }
        
        .position-item h4 {
            color: #795548;
            margin: 0 0 10px 0;
        }
        
        .position-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .results-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š RETAKEæµåŠ¨æ€§åˆ†æå™¨</h1>
        <p>åˆ†æRETAKEä»£å¸çš„Uniswap V4æµåŠ¨æ€§é…ç½®</p>
    </div>

    <div class="data-comparison">
        <h2>ğŸ“Š RETAKEä»£å¸åŸºæœ¬ä¿¡æ¯</h2>
        <div style="background: #f0f8f0; padding: 20px; border-radius: 8px; font-family: monospace;">
            <p><strong>ä»£å¸åœ°å€:</strong> 0x5eeB2662615782b58251b6f0c3E107571ae1AB07</p>
            <p><strong>WETHåœ°å€:</strong> 0x4200000000000000000000000000000000000006</p>
            <p><strong>æ€»ä¾›åº”é‡:</strong> 100,000,000,000 (1000äº¿ä»£å¸)</p>
            <p><strong>åˆå§‹ä»·æ ¼Tick:</strong> -230400</p>
            <br>
            <p><strong>æµåŠ¨æ€§ä½ç½®åˆ†é… (åŸºäº70%ä¾›åº” = 700äº¿ä»£å¸):</strong></p>
            <p>â€¢ ä½ç½®1: [-230,400, -214,000] â†’ 10% = 70äº¿ä»£å¸</p>
            <p>â€¢ ä½ç½®2: [-214,000, -155,000] â†’ 50% = 350äº¿ä»£å¸</p>
            <p>â€¢ ä½ç½®3: [-202,000, -155,000] â†’ 15% = 105äº¿ä»£å¸</p>
            <p>â€¢ ä½ç½®4: [-155,000, -120,000] â†’ 20% = 140äº¿ä»£å¸</p>
            <p>â€¢ ä½ç½®5: [-141,000, -120,000] â†’ 5% = 35äº¿ä»£å¸</p>
            <br>
            <p><strong>æ‰©å±•åˆ†é…:</strong></p>
            <p>â€¢ ClankerVault: 30% = 300äº¿ä»£å¸ (é”å®š)</p>
            <p>â€¢ DevBuy: 0.5 ETH è´­ä¹°</p>
        </div>
    </div>

    <div class="input-section">
        <h2>ğŸ“Š å¼€å§‹æµåŠ¨æ€§åˆ†æ</h2>
        <button class="analyze-btn" onclick="analyzeWithCorrectedData()">åˆ†æRETAKEæµåŠ¨æ€§é…ç½®</button>
    </div>

    <div id="results" class="results-section">
        <!-- ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <script>
        let chart = null;
        let chartMode = 'overlay';
        // ä¿®æ­£åçš„ RETAKE æ•°æ®
        const correctedRetakeData = {
            address: "0x5eeB2662615782b58251b6f0c3E107571ae1AB07",
            wethAddress: "0x4200000000000000000000000000000000000006",
            totalSupply: 100000000000, // 1000äº¿ (æ­£ç¡®)
            initialTick: -230400, // è´Ÿæ•° (æ­£ç¡®)
            positions: [
                { tickLower: -230400, tickUpper: -214000, tokens: 7000000000, percentage: 10.0, label: "ä½ç½®1 - æœ€é«˜ä»·åŒºé—´" },
                { tickLower: -214000, tickUpper: -155000, tokens: 35000000000, percentage: 50.0, label: "ä½ç½®2 - ä¸»è¦æµåŠ¨æ€§" },
                { tickLower: -202000, tickUpper: -155000, tokens: 10500000000, percentage: 15.0, label: "ä½ç½®3 - é‡å åŠ å¼º" },
                { tickLower: -155000, tickUpper: -120000, tokens: 14000000000, percentage: 20.0, label: "ä½ç½®4 - ä¸­ä»·æ”¯æ’‘" },
                { tickLower: -141000, tickUpper: -120000, tokens: 3500000000, percentage: 5.0, label: "ä½ç½®5 - é‡å åŠ å¼º" }
            ],
            extensions: [
                { name: "ClankerVault", tokens: 30000000000, percentage: 30.0 },
                { name: "DevBuy", ethAmount: 0.5 }
            ]
        };

        // æ˜¾ç¤ºä¿®æ­£åçš„æ•°æ®
        console.log("ä¿®æ­£åçš„RETAKEæ•°æ®:", correctedRetakeData);
        
        // éªŒè¯æ€»å’Œ
        const liquidityTotal = correctedRetakeData.positions.reduce((sum, pos) => sum + pos.tokens, 0);
        const extensionTotal = correctedRetakeData.extensions[0].tokens;
        const grandTotal = liquidityTotal + extensionTotal;
        
        console.log("æµåŠ¨æ€§æ€»è®¡:", liquidityTotal / 1000000000, "åäº¿");
        console.log("æ‰©å±•æ€»è®¡:", extensionTotal / 1000000000, "åäº¿");
        console.log("æ€»è®¡:", grandTotal / 1000000000, "åäº¿");
        console.log("æ˜¯å¦åŒ¹é…æ€»ä¾›åº”:", grandTotal === correctedRetakeData.totalSupply);

        // ä½¿ç”¨ä¿®æ­£æ•°æ®è¿›è¡Œåˆ†æ
        function analyzeWithCorrectedData() {
            const analysis = processRetakeData(correctedRetakeData);
            displayRetakeResults(analysis);
            document.getElementById('results').style.display = 'block';
        }

        // å¤„ç†ä¿®æ­£åçš„æ•°æ®
        function processRetakeData(data) {
            function tickToPrice(tick) {
                return Math.pow(1.0001, tick);
            }

            // æ­£ç¡®çš„ä»·æ ¼è®¡ç®—é€»è¾‘ï¼š
            // RETAKE: 0x5eeB2662615782b58251b6f0c3E107571ae1AB07
            // WETH:   0x4200000000000000000000000000000000000006  
            // ç”±äº RETAKEåœ°å€ > WETHåœ°å€ï¼Œæ‰€ä»¥ï¼štoken0 = WETH, token1 = RETAKE
            // tick è¡¨ç¤ºçš„æ˜¯ token1/token0 çš„ä»·æ ¼ï¼Œå³ RETAKE/WETH
            // æ‰€ä»¥ price = 1.0001^tick ç›´æ¥å°±æ˜¯ 1 RETAKE = ? WETH çš„ä»·æ ¼

            // å¤„ç†æ¯ä¸ªä½ç½®çš„ä»·æ ¼ä¿¡æ¯
            const processedPositions = data.positions.map((pos, index) => {
                // ç›´æ¥è®¡ç®—ä»·æ ¼ï¼Œä¸éœ€è¦å–å€’æ•°
                // tickè¶Šå¤§ï¼ŒRETAKEä»·æ ¼è¶Šé«˜
                const retakePriceLower = tickToPrice(pos.tickLower); // 1 RETAKE = ? WETH at lower tick
                const retakePriceUpper = tickToPrice(pos.tickUpper); // 1 RETAKE = ? WETH at upper tick

                return {
                    ...pos,
                    index: index + 1,
                    priceLower: retakePriceLower,
                    priceUpper: retakePriceUpper,
                    tickRange: pos.tickUpper - pos.tickLower,
                    liquidityDensity: pos.tokens / (pos.tickUpper - pos.tickLower)
                };
            });

            // è®¡ç®—ä»·æ ¼èŒƒå›´
            const allPrices = processedPositions.flatMap(p => [p.priceLower, p.priceUpper]);
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);

            // è®¡ç®—åˆå§‹ä»·æ ¼
            const initialPrice = tickToPrice(data.initialTick);

            return {
                tokenAddress: data.address,
                wethAddress: data.wethAddress,
                positions: processedPositions,
                totalSupply: data.totalSupply,
                liquiditySupply: processedPositions.reduce((sum, pos) => sum + pos.tokens, 0),
                vaultSupply: data.extensions[0].tokens,
                initialTick: data.initialTick,
                initialPrice: initialPrice,
                minPrice: minPrice,
                maxPrice: maxPrice,
                priceRange: (maxPrice / minPrice).toFixed(1),
                extensions: data.extensions
            };
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayRetakeResults(analysis) {
            const resultsDiv = document.getElementById('results');

            const html = `
                <div class="data-comparison">
                    <h2 style="color: #795548; margin-bottom: 20px;">ğŸ“Š RETAKEæµåŠ¨æ€§åˆ†æç»“æœ</h2>

                    <div class="summary-cards">
                        <div class="summary-card">
                            <h3>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                            <p><strong>ä»£å¸åœ°å€:</strong> <code>${analysis.tokenAddress}</code></p>
                            <p><strong>WETHåœ°å€:</strong> <code>${analysis.wethAddress}</code></p>
                            <p><strong>æ€»ä¾›åº”é‡:</strong> ${(analysis.totalSupply / 1000000000).toFixed(0)}åäº¿ ä»£å¸</p>
                            <p><strong>æµåŠ¨æ€§ä¾›åº”:</strong> ${(analysis.liquiditySupply / 1000000000).toFixed(0)}åäº¿ ä»£å¸</p>
                            <p><strong>é‡‘åº“é”å®š:</strong> ${(analysis.vaultSupply / 1000000000).toFixed(0)}åäº¿ ä»£å¸</p>
                        </div>

                        <div class="summary-card">
                            <h3>ğŸ’° ä»·æ ¼ä¿¡æ¯</h3>
                            <p><strong>åˆå§‹ä»·æ ¼:</strong> ${analysis.initialPrice.toExponential(3)} WETH</p>
                            <p><strong>æœ€ä½ä»·æ ¼:</strong> ${analysis.minPrice.toExponential(3)} WETH</p>
                            <p><strong>æœ€é«˜ä»·æ ¼:</strong> ${analysis.maxPrice.toExponential(3)} WETH</p>
                            <p><strong>ä»·æ ¼èŒƒå›´:</strong> ${analysis.priceRange}x</p>
                            <p><strong>åˆå§‹Tick:</strong> ${analysis.initialTick}</p>
                        </div>

                        <div class="summary-card">
                            <h3>ğŸ¯ æµåŠ¨æ€§ç­–ç•¥</h3>
                            <p><strong>æµåŠ¨æ€§ä½ç½®:</strong> ${analysis.positions.length}ä¸ª</p>
                            <p><strong>ä¸»è¦ç­–ç•¥:</strong> é›†ä¸­æµåŠ¨æ€§ + é‡å åŠ å¼º</p>
                            <p><strong>æœ€å¤§ä½ç½®:</strong> ä½ç½®2 (50% = 350åäº¿ä»£å¸)</p>
                            <p><strong>å¹³å‡å¯†åº¦:</strong> ${Math.round(analysis.positions.reduce((sum, pos) => sum + pos.liquidityDensity, 0) / analysis.positions.length).toLocaleString()} ä»£å¸/tick</p>
                        </div>
                    </div>
                </div>

                <div class="chart-section">
                    <h3>ğŸ“ˆ æµåŠ¨æ€§åˆ†å¸ƒå›¾è¡¨</h3>
                    <div class="chart-controls">
                        <button id="overlayBtn" class="active" onclick="switchChartMode('overlay')">é‡å è§†å›¾</button>
                        <button id="stackedBtn" onclick="switchChartMode('stacked')">å †å è§†å›¾</button>
                    </div>
                    <canvas id="retakeLiquidityChart" style="max-height: 400px; width: 100%;"></canvas>
                </div>

                <div class="position-details">
                    <h3>ğŸ“Š è¯¦ç»†ä½ç½®åˆ†æ</h3>
                    ${generatePositionDetails(analysis)}
                </div>
            `;

            resultsDiv.innerHTML = html;
            generateRetakeChart(analysis);
        }

        // ç”Ÿæˆä½ç½®è¯¦æƒ…
        function generatePositionDetails(analysis) {
            return analysis.positions.map(pos => `
                <div class="position-item">
                    <h4>${pos.label}</h4>
                    <div class="position-grid">
                        <div>
                            <p><strong>TickèŒƒå›´:</strong> [${pos.tickLower.toLocaleString()}, ${pos.tickUpper.toLocaleString()}]</p>
                            <p><strong>Tickå®½åº¦:</strong> ${pos.tickRange.toLocaleString()} ticks</p>
                            <p><strong>æµåŠ¨æ€§å¯†åº¦:</strong> ${Math.round(pos.liquidityDensity).toLocaleString()} ä»£å¸/tick</p>
                        </div>
                        <div>
                            <p><strong>ä»·æ ¼èŒƒå›´:</strong> [${pos.priceLower.toExponential(3)}, ${pos.priceUpper.toExponential(3)}] WETH</p>
                            <p><strong>ä»£å¸æ•°é‡:</strong> ${(pos.tokens / 1000000000).toFixed(0)}åäº¿ ä»£å¸</p>
                            <p><strong>å æ¯”:</strong> ${pos.percentage.toFixed(1)}% æµåŠ¨æ€§ä¾›åº”</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åˆ›å»ºé‡å è§†å›¾æ•°æ®é›†
        function createOverlayDatasets(analysis, colors) {
            return analysis.positions.map((pos, index) => {
                const colorConfig = colors[index % colors.length];
                return {
                    label: pos.label,
                    data: [
                        {x: pos.priceLower, y: 0},
                        {x: pos.priceLower, y: pos.tokens / 100000000},
                        {x: pos.priceUpper, y: pos.tokens / 100000000},
                        {x: pos.priceUpper, y: 0}
                    ],
                    backgroundColor: colorConfig.bg,
                    borderColor: colorConfig.border,
                    borderWidth: 2,
                    fill: true,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 8
                };
            });
        }

        // åˆ›å»ºå †å è§†å›¾æ•°æ®é›†ï¼ˆçŸ©å½¢å †å ï¼‰
        function createStackedDatasets(analysis, colors) {
            // è®¡ç®—æ¯ä¸ªä»·æ ¼åŒºé—´çš„å †å é«˜åº¦
            const stackedPositions = calculateStackedHeights(analysis.positions);
            
            return stackedPositions.map((pos, index) => {
                const colorConfig = colors[index % colors.length];
                
                return {
                    label: pos.label,
                    data: [
                        {x: pos.priceLower, y: pos.stackedBottom / 100000000},
                        {x: pos.priceLower, y: pos.stackedTop / 100000000},
                        {x: pos.priceUpper, y: pos.stackedTop / 100000000},
                        {x: pos.priceUpper, y: pos.stackedBottom / 100000000}
                    ],
                    backgroundColor: colorConfig.bg,
                    borderColor: colorConfig.border,
                    borderWidth: 2,
                    fill: true,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 8
                };
            });
        }
        
        // è®¡ç®—å †å é«˜åº¦
        function calculateStackedHeights(positions) {
            const result = [];
            
            // ä¸ºæ¯ä¸ªä½ç½®è®¡ç®—å…¶åœ¨å †å ä¸­çš„ä½ç½®
            positions.forEach((pos, index) => {
                let stackedBottom = 0;
                
                // è®¡ç®—å½“å‰ä½ç½®ä¸‹æ–¹çš„å †å é«˜åº¦
                for (let i = 0; i < index; i++) {
                    const prevPos = positions[i];
                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
                    if (pos.priceLower < prevPos.priceUpper && pos.priceUpper > prevPos.priceLower) {
                        stackedBottom += prevPos.tokens;
                    }
                }
                
                result.push({
                    ...pos,
                    stackedBottom: stackedBottom,
                    stackedTop: stackedBottom + pos.tokens
                });
            });
            
            return result;
        }

        // ç”Ÿæˆå›¾è¡¨
        function generateRetakeChart(analysis) {
            const ctx = document.getElementById('retakeLiquidityChart').getContext('2d');

            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (chart) {
                chart.destroy();
            }

            // é¢œè‰²é…ç½®
            const colors = [
                { bg: 'rgba(255, 107, 107, 0.6)', border: '#ff6b6b' },
                { bg: 'rgba(78, 205, 196, 0.6)', border: '#4ecdc4' },
                { bg: 'rgba(69, 183, 209, 0.6)', border: '#45b7d1' },
                { bg: 'rgba(156, 39, 176, 0.6)', border: '#9c27b0' },
                { bg: 'rgba(255, 152, 0, 0.6)', border: '#ff9800' }
            ];

            // æ ¹æ®å›¾è¡¨æ¨¡å¼åˆ›å»ºä¸åŒçš„æ•°æ®é›†
            const datasets = chartMode === 'stacked' ? 
                createStackedDatasets(analysis, colors) : 
                createOverlayDatasets(analysis, colors);

            // æ·»åŠ åˆå§‹ä»·æ ¼æ ‡è®°
            datasets.push({
                label: 'åˆå§‹ä»·æ ¼',
                data: [{x: analysis.initialPrice, y: 0}],
                backgroundColor: '#ff5722',
                borderColor: '#ff5722',
                pointRadius: 15,
                pointHoverRadius: 20,
                showLine: false,
                type: 'scatter'
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'RETAKEä»·æ ¼ (1 RETAKE = ? WETH) - å¯¹æ•°åˆ»åº¦',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: analysis.minPrice * 0.5,
                            max: analysis.maxPrice * 2,
                            stacked: false, // çŸ©å½¢å †å ä¸éœ€è¦Chart.jsçš„è‡ªåŠ¨å †å 
                            ticks: {
                                callback: function(value) {
                                    return value.toExponential(2);
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æµåŠ¨æ€§ (äº¿ä»£å¸)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            stacked: false, // çŸ©å½¢å †å ä¸éœ€è¦Chart.jsçš„è‡ªåŠ¨å †å 
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + 'äº¿';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'nearest',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    if (context[0].datasetIndex === datasets.length - 1) {
                                        return 'ğŸ“ åˆå§‹ä»·æ ¼æ ‡è®°';
                                    }
                                    return context[0].dataset.label;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === datasets.length - 1) {
                                        return `åˆå§‹ä»·æ ¼: ${analysis.initialPrice.toExponential(6)} WETH`;
                                    }

                                    const position = analysis.positions[context.datasetIndex];
                                    return [
                                        `ä»·æ ¼èŒƒå›´: ${position.priceLower.toExponential(6)} - ${position.priceUpper.toExponential(6)} WETH`,
                                        `æµåŠ¨æ€§: ${(position.tokens / 1000000000).toFixed(0)}åäº¿ä»£å¸ (${position.percentage.toFixed(1)}%)`,
                                        `TickèŒƒå›´: [${position.tickLower.toLocaleString()}, ${position.tickUpper.toLocaleString()}]`,
                                        `æµåŠ¨æ€§å¯†åº¦: ${Math.round(position.liquidityDensity).toLocaleString()} ä»£å¸/tick`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // åˆ‡æ¢å›¾è¡¨æ¨¡å¼
        function switchChartMode(mode) {
            chartMode = mode;
            const overlayBtn = document.getElementById('overlayBtn');
            const stackedBtn = document.getElementById('stackedBtn');

            if (mode === 'overlay') {
                overlayBtn.classList.add('active');
                stackedBtn.classList.remove('active');
            } else {
                stackedBtn.classList.add('active');
                overlayBtn.classList.remove('active');
            }

            // é‡æ–°ç”Ÿæˆå›¾è¡¨
            const resultsDiv = document.getElementById('results');
            if (resultsDiv.style.display !== 'none') {
                const analysis = processRetakeData(correctedRetakeData);
                generateRetakeChart(analysis);
            }
        }
    </script>
</body>
</html>