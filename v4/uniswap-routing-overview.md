# 背景

观察到 Base 链上 Clanker和 ZORA 发射平台的代币，即便官方提供了流动性深、手续费合理的 v4 Hook 池，Uniswap 前端默认仍然把用户导向第三方创建的无 Hook 池。这些无 Hook 池的流动性往往很浅、手续费很高，但官方界面和聚合器优先走的仍是这条路径。即使用户在前端手动切换到 “Only v4” 或 “Only Hooks”，大部分代币依然无法通过 Hook 池成交；如果使用 Uniswap X 路由则完全不会触达 Hook 池。

本文件的目的，是梳理 Uniswap 的两套路由机制、解释为何 Hook 池在默认情况下常被忽略。

## 一、Routing 基础概念

Routing（路由）是去中心化交易所用于决定 Swap 路径的机制：当用户指定输入代币、输出代币和数量后，路由器会遍历符合条件的流动性池，尝试不同的单池、串联、拆单方案，并从价格、滑点、手续费、Gas 和失败风险等维度挑选最优组合。路由发生在链上交易之前，因此是交易体验的起点；只要路由阶段找不到可执行的路径，交易就无法进入链上执行。

路由决策通常包含三个步骤：

1. **模拟**：对候选路径执行 `callStatic` 等静态调用，验证在当前链上状态下是否会回滚；
2. **评分**：对通过模拟的路径，结合净报价和估算的 Gas 成本进行排序；
3. **执行**：前端按照选定的方案构造链上交易或提交给鸣单者执行。

## 二、Uniswap 目前的两套路由

### 1. Uniswap Smart Order Router（智能订单路由器）

Smart Order Router（简称 SOR）是 Uniswap Labs 自 v2 起沿用的链上路由器。它会在 Uniswap v2、Uniswap v3、Uniswap v4 之间搜索最佳路径，只要 Hook 池被列入 Labs 的 Allowlist 也会纳入考量。

为了安全，SOR 做了几件事：
- 限制最大跳数（通常不超过三次）并过滤循环；
- 依赖后端的流动性快照，新池子需要数分钟才能进入索引；
- 在模拟 v4 Hook 池时只传递空的 `hookData`（`bytes(0)`）。一旦 Hook 需要额外参数或在空参下回滚，路径就会被标记为不可行。

### 2. Uniswap X 路由系统

Uniswap X 是 Uniswap Labs 在 2023 年推出的 Request-for-Quote（RFQ）路由系统，核心目标是让用户在“免 Gas”体验下拿到最优价格。整个流程大致分为四个环节：

1. **生成意向单**：用户在前端输入 swap 参数后，界面会构造一份链下的意向订单（order）。这份订单描述了输入资产、输出资产、最少可接受金额、有效期等信息，由用户本地签名但不会立即上链。
2. **广播订单**：意向单被发送到一个开放的 RFQ 网络。这个网络由多家第三方填单者（fillers）监听，包括做市商、套利者、MEV 团队等，他们会实时接收订单并判断是否愿意接单。
3. **计算路径并出价**：每个填单者拥有自己的路由逻辑，可以调用 Uniswap v2、Uniswap v3、Uniswap v4（含 Hook）、其他 DEX、限价单簿，甚至自家库存，来组合出一条或多条路径，然后返回一个签名报价。报价中已经包含执行成本和 gas 费用。
4. **落单与上链**：前端或协作的“结算者”（settler）会挑选最优报价。赢得订单的填单者负责在有效期内把交易发送到链上，并垫付所有 Gas；填单完成后，填单者可从成交价差或额外奖励中获利。

这种模式与传统路由最大的不同在于：路径选择权下放到多个竞争填单者，每个填单者可以根据自身优势（例如接入特定 Hook、拥有自家库存或 MEV 保护能力）来提供差异化报价。用户只需签名意向单，无需担心链上失败或 Gas 成本。

需要注意：

- Uniswap X 目前主要在以太坊主网和 Base 上启用，对订单金额、有效期等也有最低要求。只有当订单满足这些门槛时，前端才会优先尝试 Uniswap X。
- 进入竞价的资产对需要在 Labs 维护的“支持列表”中，否则订单不会被广播给填单者。
- 想让 v4 Hook 池参与 RFQ，Hook 团队必须自建或与合作伙伴共建填单者。一方面要在路由逻辑里正确调用 Hook（处理 `beforeSwap`、`afterSwap`、回滚等细节），另一方面要准备好链上结算和 Gas 垫付能力。没有可靠填单者时，Uniswap X 会忽略该 Hook 池，即使它已经通过 Allowlist。

## 三、观察到的问题

1. **默认路由偏向无 Hook 池**：在其他平台的代币中，即使官方的 v4 Hook 池拥有更深的流动性和更低的手续费，Uniswap Labs 前端、聚合器依旧默认走第三方创建的无 Hook 池。用户若不手动切换路由选项，就会落在滑点高、手续费高的池子里，使项目方无法通过 Hook 收取预期费用。
2. **Uniswap X 完全不走 Hook 池**：即便 Hook 池允许名单已生效，Uniswap X 报价里仍看不到 Hook；原因是没有专门的 filler 为该 Hook 提供 RFQ 报价。
3. **强制选择也不稳定**：即便在界面手动切换为 “Only v4” 或 “Only Hook”，部分代币依旧无法走到 Hook 池，说明即使用户强制选路，路由器仍会放弃 Hook 池。

## 四、为何 Hook 池会被限制

结合以上观察与官方规则，造成 Hook 池被绕开的主要因素包括：

- **Allowlist 门槛**：Labs 界面的 SOR 与 Uniswap X 只会考虑允许列表中的 Hook。若未提交或还在审核中，路由器根本不会把该池加入候选。
- **空 `hookData` 限制**：SOR 在模拟阶段强制使用 `bytes(0)` 作为 `hookData`。若 Hook 依赖额外参数、写外部状态、在空参下可能 `revert`，模拟就会失败，路由器也就不会在默认模式里提到它。
- **执行成本与启发式**：Hook 带来的额外逻辑往往会增加 Gas、跳数或包装/解包成本。只要综合成本比传统 v2/v3 路线高一点点，路由排序时就会被判为“不是最优路径”。此外，SOR 还对跳数、循环路径有硬性限制，复杂 Hook 链路可能直接被过滤。
- **风险标记**：Allowlist 与风险评级系统独立存在。若 Hook 触发 Labs 的 standard/dangerous 警示，界面会提示风险，路由器也倾向跳过，以免给终端用户带来未知行为。
- **Uniswap X 填单者缺失**：RFQ 体系下，只有当有人愿意跑 filler 并补齐 Hook 的自定义逻辑时，Hook 池才会进入竞价。没有 filler，Uniswap X 视同不存在。
- **索引延迟**：新建 Hook 池或流动性波动较大时，索引器更新需要时间；在更新完成前，池子处于“看得见但未评估”的状态。

这些机制解释了我们看到的现象：默认路由要么因为允许列表、风控或 `hookData` 模拟失败而把 Hook 过滤掉，要么在评分阶段认为 Hook 不够“利于用户”，转而使用简单但高费率的第三方池。

## 五、对我们项目的影响

在我们自建的前端里，仍可以通过直接指定官方池地址来强制使用 Hook 流动性；但一旦用户前往 Uniswap 官方界面或其他聚合器，我们无法左右默认的路径选择，他们很可能被导向第三方池，导致：

- 官方 Hook 池的流动量、手续费回收被压缩；
- 投机者可以故意部署高费率、低流动性的池子截留流量；
- 终端用户在这些前端遭遇更高的滑点与成本，进而影响我们代币的整体交易体验。

## 六、下一步计划

1. **申请 Hook Allowlist 并完成合规材料**  
   - 准备 Hook 合约说明、审计报告、功能文档，向 Uniswap Labs 提交 allowlist 申请。  
   - 虽然 Allowlist 不能直接解决路由问题，但这是让 Hook 至少进入候选集合的前提，也能同步排查是否存在风控标记。  
   - 申请完成后，需要主动跟进 Labs 支援，确认 Hook 在主网/Base 上都已生效，并记录可能的索引延迟。

2. **评估并筹备 Uniswap X 填单者**  
   - Uniswap X 属于新的 RFQ 路由体系，想要利用其流量，就必须运营能够理解 Hook 逻辑的 filler。  
   - 需要评估运营成本：包括链上 Gas 垫付、基础设施维护、风控监控以及与前端协同的服务成本。  
   - 若短期内资源不足，可先做技术预研，明确实现路径（自建、委托第三方或与做市商合作），再决定是否投入。

3. **对接外部聚合器与生态前端**  
   - 主动联系 1inch、OKX 等聚合器团队，提交 Hook 合约、审计报告、仿真脚本等材料，申请进入其协议白名单。  
  - 关注他们的接入流程，必要时提供定制化的 connector 或 SDK 支持，并收集对方对 Hook 的安全、风控要求。  

这些行动可以让我们的 Hook 池逐步突破路由限制，从必要的“准入”走向真正的“优先被选”，在不同前端和聚合器里都保持一致的成交路径。
